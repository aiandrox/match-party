# Firestore容量分析とゲーム数概算

## Firebase Firestore無料枠制限 (2025年)

### 日次制限
- **ドキュメント読み取り**: 50,000回/日
- **ドキュメント書き込み・削除**: 20,000回/日

### ストレージ制限
- **保存データ**: 1 GiB
- **アウトバウンドデータ転送**: 10 GiB/月

### 制限リセット
- 太平洋時間午前0時頃に日次クォータがリセット

## 現在のデータ構造とFirestore操作

### 1ゲームセッション当たりのドキュメント数
**参加者N人、ラウンドR回のゲームの場合**:
- **rooms**: 1ドキュメント
- **users**: N ドキュメント
- **gameRounds**: R ドキュメント
- **gameAnswers**: N × R ドキュメント (最大)

**合計**: 1 + N + R + (N × R) = 1 + N + R + NR = 1 + N(1 + R) + R

### 1ゲームセッション当たりの読み取り操作数
**参加者N人、ラウンドR回のゲームの場合**:

#### 初期設定（1回限り）
- ルーム作成時のコード重複チェック: 1-10回
- ルーム作成: 1回
- ホストユーザー作成後の確認: 1回
- 参加者加入時の確認: (N-1)回
- **小計**: 3 + N-1 = N+2 回

#### ゲームプレイ中
- ゲーム開始時: 1回
- 回答送信時の確認: N × R回
- 判定・ラウンド完了時: R回
- 次ラウンド開始時: (R-1)回
- **小計**: 1 + NR + R + (R-1) = NR + 2R = R(N+2) 回

#### リアルタイムリスナー
- ルーム監視: 継続的（推定N × R × 5回）
- ゲームラウンド監視: 断続的（推定R × 2回）
- **小計**: 5NR + 2R = R(5N+2) 回

#### **読み取り操作合計**
**(N+2) + R(N+2) + R(5N+2) = (N+2)(1+R) + R(5N+2) = (N+2)(1+R) + R(5N+2)**

**簡略化**: **約 6NR + 3N + 4R 回**

### 1ゲームセッション当たりの書き込み操作数
**参加者N人、ラウンドR回のゲームの場合**:

#### 初期設定
- ルーム作成: 1回
- ホストユーザー作成: 1回
- ルーム参加者リスト更新: 1回
- 参加者ユーザー作成: (N-1)回
- 参加者加入時のルーム更新: (N-1)回
- **小計**: 3 + 2(N-1) = 2N+1 回

#### ゲームプレイ中
- ゲーム開始（ゲームラウンド作成＋ルーム更新）: 2回
- 回答送信（回答作成＋ルーム更新）: 2N × R回
- 判定（ゲームラウンド更新）: R回
- 次ラウンド開始（前ラウンド完了＋新ラウンド作成＋ルーム更新）: 3(R-1)回
- **小計**: 2 + 2NR + R + 3(R-1) = 2NR + 6R - 1 回

#### **書き込み操作合計**
**(2N+1) + (2NR + 6R - 1) = 2N + 2NR + 6R = 2N(1+R) + 6R**

**簡略化**: **約 2NR + 2N + 6R 回**

### ストレージ使用量
**参加者N人、ラウンドR回のゲームの場合**:
- **rooms**: 1 × 3KB = 3KB
- **users**: N × 300bytes = 0.3N KB
- **gameRounds**: R × 400bytes = 0.4R KB
- **gameAnswers**: NR × 300bytes = 0.3NR KB
- **合計**: 3 + 0.3N + 0.4R + 0.3NR KB

**簡略化**: **約 0.3NR + 0.3N + 0.4R + 3 KB**

## ユースケース別ゲーム数概算

### ケース1: 小規模ゲーム（3人、2ラウンド）
- **参加者**: 3人
- **ラウンド**: 2回
- **読み取り**: 6×3×2 + 3×3 + 4×2 = 36 + 9 + 8 = **53回**
- **書き込み**: 2×3×2 + 2×3 + 6×2 = 12 + 6 + 12 = **30回**
- **ストレージ**: 0.3×3×2 + 0.3×3 + 0.4×2 + 3 = 1.8 + 0.9 + 0.8 + 3 = **6.5KB**

**日次上限に達するまで**:
- **読み取り制限**: 50,000 ÷ 53 = **943ゲーム/日**
- **書き込み制限**: 20,000 ÷ 30 = **666ゲーム/日** ← **制限要因**
- **ストレージ制限**: 1GB ÷ 6.5KB = **157,538ゲーム**

### ケース2: 中規模ゲーム（5人、3ラウンド）
- **参加者**: 5人
- **ラウンド**: 3回
- **読み取り**: 6×5×3 + 3×5 + 4×3 = 90 + 15 + 12 = **117回**
- **書き込み**: 2×5×3 + 2×5 + 6×3 = 30 + 10 + 18 = **58回**
- **ストレージ**: 0.3×5×3 + 0.3×5 + 0.4×3 + 3 = 4.5 + 1.5 + 1.2 + 3 = **10.2KB**

**日次上限に達するまで**:
- **読み取り制限**: 50,000 ÷ 117 = **427ゲーム/日**
- **書き込み制限**: 20,000 ÷ 58 = **344ゲーム/日** ← **制限要因**
- **ストレージ制限**: 1GB ÷ 10.2KB = **100,271ゲーム**

### ケース3: 大規模ゲーム（10人、5ラウンド）
- **参加者**: 10人
- **ラウンド**: 5回
- **読み取り**: 6×10×5 + 3×10 + 4×5 = 300 + 30 + 20 = **350回**
- **書き込み**: 2×10×5 + 2×10 + 6×5 = 100 + 20 + 30 = **150回**
- **ストレージ**: 0.3×10×5 + 0.3×10 + 0.4×5 + 3 = 15 + 3 + 2 + 3 = **23KB**

**日次上限に達するまで**:
- **読み取り制限**: 50,000 ÷ 350 = **142ゲーム/日**
- **書き込み制限**: 20,000 ÷ 150 = **133ゲーム/日** ← **制限要因**
- **ストレージ制限**: 1GB ÷ 23KB = **44,408ゲーム**

### ケース4: 最大規模ゲーム（20人、10ラウンド）
- **参加者**: 20人
- **ラウンド**: 10回
- **読み取り**: 6×20×10 + 3×20 + 4×10 = 1200 + 60 + 40 = **1,300回**
- **書き込み**: 2×20×10 + 2×20 + 6×10 = 400 + 40 + 60 = **500回**
- **ストレージ**: 0.3×20×10 + 0.3×20 + 0.4×10 + 3 = 60 + 6 + 4 + 3 = **73KB**

**日次上限に達するまで**:
- **読み取り制限**: 50,000 ÷ 1,300 = **38ゲーム/日**
- **書き込み制限**: 20,000 ÷ 500 = **40ゲーム/日**
- **ストレージ制限**: 1GB ÷ 73KB = **14,004ゲーム**

## 分析結果とボトルネック

### 主要なボトルネック
1. **書き込み制限が最も制限的**: 全てのケースで書き込み制限が先にヒット
2. **読み取り制限**: 大規模ゲームでは読み取り制限も問題となる
3. **ストレージ制限**: 短期的には問題にならないが、長期的には要注意

### 推奨運用パターン
**現実的な持続可能運用**:
- **小規模ゲーム（3人、2ラウンド）**: 600ゲーム/日
- **中規模ゲーム（5人、3ラウンド）**: 300ゲーム/日  
- **大規模ゲーム（10人、5ラウンド）**: 130ゲーム/日
- **最大規模ゲーム（20人、10ラウンド）**: 35ゲーム/日

### 最適化提案
1. **ドキュメント削除機能**: 30分後のルーム削除実装
2. **バッチ処理**: 複数の書き込み操作を1トランザクションで処理
3. **読み取り最適化**: 不要なリアルタイムリスナーの削除
4. **キャッシュ活用**: ローカルストレージでの重複読み取り防止

## 結論

**Firebase無料枠での運用は実用的**で、日次数百ゲームの処理が可能です。

**制限要因は書き込み操作数**であり、参加者数とラウンド数に比例して制限が厳しくなります。

**推奨運用モード**: 5人、3ラウンドの中規模ゲームを中心とした運用で、日次300ゲーム程度が安全な運用範囲です。