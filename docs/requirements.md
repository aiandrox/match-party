# 詳細要件定義

**プロジェクト状態**: ✅ Phase 7完了・エンタープライズ品質基盤実現（テスト・CI/CD・IaC）
**稼働URL**: https://match-party-findy.web.app/
**最終更新**: 2025-07-19

## 1. 技術的な確認事項

### Firebase設定
- **アカウント**: 個人アカウント
- **料金プラン**: Blazeプラン（従量課金、無料枠内で運用）
- **地域設定**: asia-northeast1
- **Cloud Functions**: v2、毎日自動クリーンアップ稼働中

### 開発環境
- **Node.js**: v20以上の最新安定版、バージョン管理を実施
- **パッケージマネージャー**: npm使用
- **インフラ管理**: Terraform/OpenTofu によるIAM権限管理

## 2. 機能仕様の詳細

### 認証方式
- **方式**: 名前入力のみ
- **重複**: 同じルーム内では許可しない（先着順）
- **名前制限**: 2文字以上20文字以下、日本語・英語・数字を許可

### ルーム管理
- **ルームコード**: 20文字、英数字を使用
- **同時接続上限**: 20人（今後変更の可能性あり）
- **ルーム有効期限**: 30分（今後変更の可能性あり）

### お題管理
- **お題**: 事前定義、JSONなどでコード管理
- **カテゴリ分け**: 不要（全ルーム共通）
- **お題制限**: 30文字以下、日本語・英語・数字・記号を許可

## 3. UI/UX要件

### デザインシステム
- **ガイドライン**: シンプルで直感的なUIを目指す
- **カラーパレット**: 明るいトーンを基調
- **フォント**: 読みやすさを重視
- **レスポンシブ**: スマホ・タブレット・PCでの最適化

### 音声・効果
- **MVPフェーズ**: 音声効果は不要（後のフェーズで検討）

## 4. 運用・保守

### 監視・ログ
- **エラー監視**: Sentry等は導入しない、エラー時にSlack通知
- **アクセス解析**: Google Analytics等は導入しない（後のフェーズで検討）
- **パフォーマンス監視**: 導入しない（後のフェーズで検討）

### セキュリティ
- **不適切な回答対策**: MVPではやらない（後のフェーズで検討）
- **スパム対策**: 工数次第。同一IPからの短時間大量アクセス制限
- **レート制限**: 工数次第。一定時間内のリクエスト数制限

## 5. 実装優先度

### MVP Phase 1（プロジェクト基盤）- ✅ 完了
- [x] Next.js 15 + TypeScript + Tailwind CSS環境構築
- [x] Firebase SDK統合とFirestore設定
- [x] 基本的なフォルダ構造とコンポーネント設計
- [x] ホームページとナビゲーション
- [x] Firebase Hostingデプロイ設定

### MVP Phase 2（ルーム管理）- ✅ 完了
- [x] ルーム作成機能（20文字コード生成、重複チェック）
- [x] ルーム参加機能（名前バリデーション、人数制限）
- [x] 参加者一覧とリアルタイム更新
- [x] ホスト権限管理とゲーム開始制御
- [x] セキュリティ強化（参加権限、有効期限管理）
- [x] localStorage活用したユーザー識別システム

### MVP Phase 3（ゲーム機能）- ✅ 完了
- [x] ゲーム開始とお題表示システム
- [x] 30個のお題データ（JSON形式）
- [x] 回答送信とリアルタイム同期
- [x] 全員回答完了の自動判定
- [x] 回答公開機能
- [x] 主催者による手動一致判定
- [x] 判定結果の全参加者への配信
- [x] ゲーム状態管理（waiting → playing → revealing）

### Phase 4（データ管理・運用）- ✅ 完了
- [x] 自動クリーンアップ機能実装（Cloud Functions v2）
- [x] 期限切れルーム削除（毎日午前0時実行）
- [x] 長期運用基盤整備
- [x] デプロイ・本番稼働開始

### Phase 5（品質・最適化）- ✅ 完了
- [x] Firebase Functions v2完全移行
- [x] CI/CD最適化（Functions自動ビルド統合）
- [x] UI/UX統一（戻るボタン動作一貫性）
- [x] お題データ拡張（30→447個）
- [x] TopicData型簡素化（interface→string）
- [x] エラー解決・型安全性確保

### Phase 6（アーキテクチャリファクタリング）- ✅ 完了
- [x] 全アプリケーション完全リファクタリング（MVP + Facade + Container-Component パターン）
- [x] app/roomディレクトリ完全リファクタリング（1,092行→モジュラー設計）
- [x] app/create-roomディレクトリ リファクタリング（106行→MVP パターン）
- [x] app/join-roomディレクトリ リファクタリング（158行→MVP パターン）
- [x] MVP（Model-View-Presenter）パターン全ページ統一
- [x] Facadeパターンによるグローバル状態管理
- [x] Container-Componentパターンによる完全な責務分離
- [x] Custom Hookパターンによるビジネスロジック再利用化
- [x] 各ページの独立コンポーネント化とアーキテクチャ統一
- [x] ESLintルール最適化（未使用パラメータ警告解決）

### Phase 7（テスト基盤構築・CI/CD統合・IaC）- ✅ 完了
- [x] Jest + Testing Library テスト環境構築完了
- [x] Presenter層ユニットテスト実装（CreateRoom・JoinRoom）
- [x] Utils層ユニットテスト実装（バリデーション・ルームコード生成等）
- [x] 44個のテスト実装、全テスト合格確認
- [x] カバレッジ測定機能実装（Jest Coverage）
- [x] CI/CDパイプライン構築（GitHub Actions 4段階ワークフロー）
- [x] テスト失敗時のデプロイ停止機能
- [x] カバレッジレポート自動生成・HTML出力
- [x] Firestore security rules強化（create/update時制約）
- [x] Firebase全サービスCI/CD統合（Firestore・Functions・Hosting）
- [x] Terraform/OpenTofuによるIAM権限管理（14権限をコード管理）
- [x] インフラストラクチャ・アズ・コード基盤確立

### Phase 8（将来拡張）- 📋 将来検討
- [ ] 音声・視覚効果の追加
- [ ] 複数ラウンドでの得点システム
- [ ] 監視・ログ機能強化（APM・アラート）
- [ ] パフォーマンス最適化
- [ ] 不適切コンテンツ対策
- [ ] WAF・CDN設定のコード化

## 6. 技術的制約

### Firebase無料枠制限
- **Firestore**: 読み取り50,000回/日、書き込み20,000回/日
- **Cloud Functions**: 呼び出し2,000,000回/月
- **Hosting**: 10GB/月

### Rate Limit対策
- 制限に達した場合の適切なエラーメッセージ表示
- ユーザーへの制限状況の透明性確保

## 7. 開発時の注意点

### データ設計
- 無料枠を意識した効率的なクエリ設計
- 不要な読み書きを避ける構造

### UI/UX
- ローディング状態の適切な表示
- エラー状態の分かりやすい表示
- モバイルファーストのレスポンシブデザイン